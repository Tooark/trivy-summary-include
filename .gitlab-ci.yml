spec:
  inputs:
    architecture:
      description: "Architecture (amd64 or arm64)"
      type: string
      default: ""
---

stages:
- scan

variables:
  TRIVY_JSON: "gl-container-scanning-report.json"
  TRIVY_IMAGE: public.ecr.aws/n6a9k4a7/deploy:1-trivy

.docker_scan:
  rules:
  - if: '"$[[ inputs.architecture | expand_vars ]]" == ""'
  stage: scan
  image: $TRIVY_IMAGE
  script:
  - trivy image $DOCKER_IMAGE | tee $TRIVY_JSON
  artifacts:
    paths:
    - $TRIVY_JSON
    untracked: false
    when: on_success
    access: developer
    expire_in: "30 days"

.docker_scan_amd64:
  rules:
  - if: '"$[[ inputs.architecture | expand_vars ]]" == "amd64"'
  stage: scan
  image: aquasec/trivy:latest
  script:
  - trivy image $DOCKER_IMAGE | tee $TRIVY_JSON
  artifacts:
    paths:
    - $TRIVY_JSON
    untracked: false
    when: on_success
    access: developer
    expire_in: "30 days"
  tags:
  - amd64
